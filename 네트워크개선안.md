## 개선 사항

일부 소스 내용만 파악한 상태에서 구두로 전해들은 내용을 토대로 작성한 내용이므로, 상황상 필요하지 않은 내용이 언급되어 있을수도 있습니다.

이점 참고해 주시면 감사하겠습니다. 이글을 작성하게 된 이유는 개선 사항에 대해서 의견을 나누기 전에 어느정도 정리된 내용이 있으면, 대화의 흐름이 원활하지 않을까 싶어서 작성하게 되었습니다.

제가 전해들은 개선이 필요한 사항들은 다음의 내용들 정도인듯 싶습니다. 추가로 해당 내용이 더 있다면 별도로 언급해주시면 반영하도록 하겠습니다.

- 네트워크 단절시 연결 유지
- 네트워크 단절 사유 명확하게 구분
- 네트워크 트래픽 감소


### 네트워크 단절시 연결 유지

모바일 특성상 `Hand over` 상황에서 짧은 시간동안 네트워크가 끊기거나 절체되는 경우가 종종 있습니다. 이러한 부분을 개선해야만 서비스 품질을 향상할 수 있을 것입니다.

상태를 가진 서버(stateful) 즉, 실시간 게임서버에서는 단순히 연결만 다시 이어준다고해서 문제가 해결되지 않습니다. 단순히 연결만 복구하는 형태로 대응한다면 다음과 같은 문제가 있을 수 있습니다.

- 메시지 유실이 발생할 수 있습니다.
  서버에서 클라이언트로 혹은 그반대로 메시지를 보냈다하여 상대측이 해당 메시지를 받았다는 보장을 할 수 없습니다.
  수신측에서 메시지를 받았다는 응답(확인)을 주어야 신뢰성(Reliability)을 담보할 수 있을것입니다.

- 메시지 유실로 인한 상태 훼손
  네트워크 메시지를 통해서 서버/클라간 상태를 동기화하는데 중간에 메시지가 유실된다면, 온전한 상태를 동기화할 수 없게됩니다.
  예를들어 드랍된 장비를 주워서 장착을 하였다고 할 때 장비를 획득한 메시지는 받았지만, 장착에 해당하는 메시지를 수신하기 전에
  연결이 끊기고 연결 복원을(재연결) 하게 된다면, 장비가 장착이 되지 않은 상태로 플레이를 하게 될것입니다.

- 상태가 망가졌으므로, 더 이상의 이상 현상을 방지하기 위해서 `홈` 화면으로 보낸 후 처음부터 재시작 하게 한다면, 플레이어는 피로감을 가질수 밨에 없을것입니다.
  `홈`으로 보낸 후 처음부터 재개한다면 손쉬운 처리방법이기는 하지만, 플레이 경험을 저해하는 요소가 될것입니다.

그외에 고려해야할 부분입니다.

- 물리적 혹은 OS의 네트워크 단절 감지 타이밍이 즉각적이지 않기에, 재연결 처리가 기민하게 동작하지 않습니다.
  짧은시간(수초이내) 내의 네트워크 단절을 개선한다는 의미로 접근해야지 긴시간동안 끊겼을 경우에는 현실적으로 완벽하게 대응하기는 어렵습니다. 예를들어서 긴시간후 연결이 복원되었는데 이미 게임이 끝나버린 경우도 있을것입니다.

- `Load Balancer`뒷단에 서버가 위치해있는 경우 재연결
  `Load Balancer`뒤에 여러대의 서버가 있는 경우 재연결시에 이전에 플레이 했던 서버가 아닌 다른 서버에 연결될수도 있습니다.
  (쏠림 현상등의 이유로 `Sticky Session` 사용은 고민이 필요할 수 있습니다.)
  이전에 접속했던 서버가 아닌 다른 서버에 접속하는 경우에는 서버 입장에서는 처음 접속하는 것으로 간주하여 플레이 상태를 가져올 수 없습니다.
  반듯이 이전에 플레이 했던 서버로 접속해야하며, 각 서버에 `Public IP`를 부여해서 해당 서버로 재연결할 수 있도록 해야합니다.
  이전에 플레이 했던 서버의 메모리에 해당 플레이어의 상태가 있기 때문입니다.

- 연결 복원 시점에서는 어떤일이 발생하는지?
  연결직 후 세션 성립을 위해서 키교환등을 거친 후 서버/클라 모두 상태측에서 못받았던 메시지를 전송하고 수신합니다.
  이때 못받았던 메시지를 한번에 지연없이 몰아서 받기 때문에 순간적으로 캐릭터 움직임이 급격하게 변하는등의 현상이 있을수 있습니다.
  여기서 대응하는 내용은 이러한 현상을 완화하기 위한 목적이 아닌 상태를 동기화를 이어가기 위한 목적이므로, 순간적으로 동기를 맞추는것입니다.

구현 관련한 내용은 [이글](https://github.com/maxidea1024/public-articles/blob/master/reliable-session.md) 참고하세요.
다만, 완벽하게 디테일한 구현 내용을 담은것은 아니고 구현 원리에 대해서 설명해봤습니다.


### 네트워크 단절 사유 명확하게 구분

서버에서 문제가 있어서 연결이 끊긴것인지 아니면 의도적으로 끊은것인지 혹은 반대로 클라이언트에서 버그 혹은 의도에 의해서 끊은것인지 명확하게 이유를 전달할 필요가 있습니다.

모든 상황을 명확하게 알 수는 없지만, 알수 있는 상황들에 대해서는 손쉽게 구분할 수 있도록 대응을 해주는게 여러모로 좋습니다.

의도한것인지 아닌지를 구분짓는 것도 중요하지만, 끊기는 이유에 대해서 명확히 파악이 되어야 버그인지 아닌지 알수 있을것입니다. 버그라고 판단되면, 해당 버그를 수정하는 기본적인 힌트가 될것이기 때문입니다. 이러한 원인이 파악이 되지 않는다면, 서버 측 이유인지 클라이언트 측 이유인지 그것도 아니면 단순히 물리적으로 네트워크 단절에 대해서 설왕설래하며 패닉상황에 놓이게 될것입니다.

자세한 구현에 대해서는 이글에서 논하지 않겠지만, 네트워크 단절시 호출되는 콜백에 끊김 사유를 같이 전달해준다면, 문제를 해결하는 실마리를 제공할 수 있을것입니다.

제가 모든 소스를 면밀히 파악한것은 아니지만, 기본 네트워크 처리 부분을 확인한 바로는 `Disconnect` 사유를 파악할 수 있는 구조가 아닌것으로 보입니다. 이 부분을 정리하고 보완한다면 개발 과정이 조금은 수월해질수 있지 않나 싶습니다.

끊김사유를 명확하게 하기위해 하는 방법중에 하나는 서버에서 일방적으로 클라이언트를 끊는게 아니라, 클라이언트 스스로 끊어지도록 서버에서 지령을 내리는 형태로 처리하는 것입니다. 이런 처리가 들어가므로서 최소한 서버가 나를 끊었구나에 해당하는 케이스는 명확하게 알수 있습니다. 반대로 서버에서는 클라이언트가 명확하게 끊었는지 알고 싶기는 하겠지만 언제 끊어질지 모르는 클라이언트이므로 꼭 필요하도고는 볼수 없습니다. 옵션사항으로 구현하기도 하므로, 필요하다면 생각해볼 여지는 있습니다.

하지만, 대부분의 끊기는 이유를 서버의 버그이므로 원인이 되는 서버의 버그를 해결하는게 우선일것입니다.

### 네트워크 트래픽 감소

기본적으로 많이 보내고 최적화하는데는 한계가 있습니다. 아무리 좋은 네트워크 엔진이라고 해도 감당할 수 없는 데이터를 `IO`에 요청하게 되면 물리적으로 처리 한계를 넘게 됩니다. 1,0000 명 받을것을 100 명밖에 못받는 상황이 발생할수 있다는 얘기입니다.

일단 데이터를 많이 보내는 상항에서 개선하기 보다는 애초에 보내는 횟수와 크기를 줄이는 노력부터 해야할것입니다. 물론 구조적으로 `IO`만 전담하는 서버를 별도로 두어서 트래픽을 분산할수도 있지겠지만, 이부분은 구조적인 변화를 수반하기 때문에 언급하지 않도록 하겠습니다.

오픈월드에서 가장 큰 부분을 차지하는 트래픽은 움직임 동기화관련된 메시지들일것입니다. 우선은 이부분만 개선을 해보면 어떨가 싶습니다.

보통의 경우 `Relevancy`에 근거를 두어서 트래픽 제어를 하게 됩니다. 해당 오브젝트에게 얼마만큼의 동기 디테일을 줘야하나 하는 이슈입니다.

다음과 같은 우선순위 배정룰입니다.

- 플레이어(나)의 우선순위가 가장 높음
- 플레이어 위치에서 가까운 오브젝트 또는 나에게 다가오는 플레이어
- 상호작용이 필요한 경우
- 일정 반경을 벗어나는 경우 아예 동기화 대상에서 아예 제외

우선은 월드 전체를 동기화영역(Synchronization Scope)으로 처리하게 되면 동기화 대상이 너무 많게 될수 있으므로, 플레이어(관측자) 주변 일정 반경내에 있는 오브젝트들만 동기화의 대상으로 삼아서 처리해야합니다. 이러한 동기화 영역 관리는 서버에서 이뤄지며 일정부분 동적으로 스로틀링(throttling)하기도 합니다.

다음의 이슈들이 있을 수 있습니다.

- 동기화 영역의 크기는 어느정도로?
  너무 작아도 너무 커도 문제가 될수 있습니다.
  너무 작은 경우에는 다른 유저가 플레이어 근처에 왔을때만 보이게 되기 때문에 다른 유저와의 클릭을 통한 상호작용들에 제약을
  받게 될것입니다. 많이 불편한 상황이 만들어 질수있습니다.
  플레이를 저해하지 않는 선에서 적절한 크기(보통은 반경)를 잡아주는것이 좋을것입니다. 이부분은 게임에 따라서 판단해야하므로,
  약간의 실험이 필요할수 있습니다. (필요하다면, 반경을 능동적으로 조절할수도 있습니다.)

- 한곳에 플레이어들이 몰린다면?
  이 경우에는 사실상 답이 없습니다. 기획적으로 최대한 분산을 유도하거나 채널링을 통해서 최대 인원을 제한하는 형태로 대응할 수 밖에 없습니다.
  아니면, `Latency`, 시야에 들어온 플레이어들의 수를 고려해서 업데이트 전송 주기를 일점 범위내에서 동적으로 조절하는 방안에 대해서도 고려할 수 있을것입니다. 예를들어, 100명 이하일때는 초당 10회, 200이하일때는 초당 5회 정해진 룰이 있는것은 아니고 대략 이런식으로 접근이 가능할것입니다. 클라이언트에서의 `LOD(Level Of Detail)`와 같은 맥락이라고 보시면 되겠습니다.
  한편으로는 한곳에 몰리게 되면 트래픽 부담에 앞서서 클라이언트가 렌더링하기에도 벅찬상황일수 있을것입니다.

- 시야에 새로 나타거나 사라지거나
  시야에 없던 플레이어가 들어오게 되면 해당 플레이어를 표현할 부가 정보들이 필요하므로 진입 메시지가 날라오게 될것이고,
  시야에서 벗어나게 되면 벗어남 메시지가 오거나, 업데이트 목록에서 빠지게 됩니다. 이러한 메시지들은 사실상 이벤트이므로
  이러한 이벤트가 너무 빈번하게 오가지 않도록 주의해야합니다. 이벤트 데이터가 다소 클수도 있기 때문입니다.

- 플레이어가 동기화 영역 경계에서 들락날락(Churn) 한다면?
  동기화 영역 경계를 너무 칼같이 잡아 놓게 되면, 살짝살짝 움직일 때도 `In`, `Out` 처리가 발생하기 때문에, 보여야하는 타 플레이어 정보 메시지 송수신 량이 늘어나게 됩니다.
  이러한 문제점을 완화하기 위해서 동기화영역 반경에 `Loose` 팩터를 두어서 일정 거리이상 들락날락하는 경우에는 `In`, `Out` 이 발생하지 않은것으로 처리해야합니다.
  말이 좀 어려울수도 있는데, 동기화 영역 바깥쪽에 `완충지대(Dead band)`를 주어서 들락날락하는 현상을 완화할 수 있습니다.

- 서버내에서의 공간분할
  시야관리를 서버에서 하기 때문에 월드상에서 오브젝트들을 빠르게 검색할 수 있는 수단이 필요합니다.
  선형 탐색을 통해서 전체를 훑어서 처리해도 되겠지만, 관리해야되는 오브젝트수가 많아지게 되면 단순 검색 단계에서 지수형태의 부하가 발생할 수도 있습니다. 공간분할을 통해서 검색 시간을 최소화해야 효율적인 처리가 가능할것입니다.
  복잡한 공간분할 까지는 필요없고, 간단한 `Uniform Grid`, `QuadTree`, `Octree` 정도면 충분할것입니다.
  (서버에서는 공간해시의 개념으로 `Uniform Grid`정도여도 충분합니다. 일단 구현도 쉽고. 흔히 말하는 바둑판을 말합니다. 단, 1:1로 각 공간에 대응할 필요는 없습니다. 검색을 빨리하기 위한 용도이지 바로 찾아내기 위한 용도는 아닙니다. Hash bucket으로 생각하시면 되겠습니다.)


  ### 개발 소요시간

  서버/클라 모두 같이 움직여야 달성이 가능한 내용이므로 준비기간과 적용기간이 필요합니다. 구체적인 스케줄 산출은 프로젝트 진행상황과 각 파트별 담당자분들의 의견을 수렴한 후 산출을 해봐야할것입니다.

  우선 제 개인적인 예상임을 전재로 말씀드리면, 코어쪽 작업은 10일정도 예상되며 실적용 및 테스트는 2주정도 예상이됩니다.

  안건 공유 후 의견 수럼을 거치면 조금더 구체적인 스케줄 산출이 가능할것으로 생각됩니다.
  