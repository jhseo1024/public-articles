## PlayTogether Server 개발 이슈
---

구체적인 작업 계획 및 스케줄 산출을 위한 러프한 내용 리스트업입니다. 내용을 정리해나가면서, 구체적인 스케줄을 산출하는게 최종 목표입니다. 현재, 아래의 내용외에 추가로 정리중이며 차후 취합하여 공유드리도록 하겠습니다. 클라이언트 분들의 경우 서버 작업에 대해서 상세히 알필요는 없겠지만, 어떤 작업들을 하고 있는지 파악하시는데 도움이 되지 않을까 싶어 공유드립니다.

내용이 정리되는 대로 내일까지 체크 리스트 형태로 작성될 예정입니다.

### 개발 이슈들
1. 채널 관리 버그들
2. 리얼타임 통신 안정화 및 최적화
3. 라이브 상황에서 리얼타임 서버 동적 스케일링
4. SP(Stored Procedure) 사용 줄이기
5. 서버 배포 과정 간소화 및 자동화
6. 서버 디버깅 환경 보강
7. 서버 로그 정리
8. 인벤토리 등에서의 갯수 제한
9. 리얼타임 서버에서 DB에 직접 접근
10. 서버 이름 정리

번호가 우선순위라고 생각하시면 되겠습니다.

#### 용어(Terminology)

##### 단일고장점(SPOF; Single Point Of Failure)
- 어느 한부분이 고장나면 모든 서비스가 중지되는 부분이나 요소를 지칭함.

##### 고가용성(HA; High Availability)
- 장애 발생시에도 서비스가 유지되는지 여부를 말함.
  (하나가 죽어도 동일한 역활을 하는 다른 하나의 시스템이 대신함)

##### WAS(Web Application Server)
- 웹 기반의 응용프로그램 서버(API서버라고도 함)

##### Service Discovery
- 서버의 목록을 미리 알아야만 하는 구조에서는 스케일링이 용이하지 않으므로,
  서버 기동시 또는 셧다운시에 동적으로 서버 목록과 역활을 알 수 있도록 하여
  스케일링에 유연한 구조를 만들기 위해 필요.

---

#### 1. 채널 관리 버그들 (필수사항)
- 이동간 불안정한 상태 픽스
- 부분 실패시 상태가 변경되어 훼손되는 문제점 해소
- 카운팅 정상화(인원, 집 카운터등)
- 동적으로 서버 스케일링 안됨(이 부분은 별도로 다룸)
- 기타 내용 추가 파악중

#### 2. 리얼타임 통신 안정화 및 최적화 (필수사항)
- 재접속시에 유실되는 메시지가 없도록 처리(Reliable Session)
- Suspended 되었을 경우에 각 상황에 맞춰서 timeout적용
- 동기화 영역 관리(시야관리)
  Broadcasting되는 영역을 일정 범위내에서 관리해서 `IO 병목`을 최대한 억제함.

#### 3. 라이브 상황에서 리얼타임 서버 동적 스케일링 (필수사항)
- 새로 서버를 띄우면 자동으로 인식(Discovery)되는 구조로 설계
  (기존에는 서버 주소를 별도의 맵핑 테이블 형태로 관리)
- 기존 서버를 제거할때도 안전하게 제거할 수 있도록 설계
  (작업자가 별도로 Operation해야하는 과정을 최대한 줄임)
- 각 서버의 주소와 역활은 동적으로 구성할 수 있도록 함.
  (Discovery 가능한 구조로 설계)
- 기존 각 실시간 서버의 상태들이 `Lobby`서버에 위치해 있어서 스케일링 하기가 용이하지 않고,
  `Lobby`서버가 `고가용성(HA)`이 보장이 안되는 구조이므로, `단일고장점(SPOF)`이 될수 있는 상태임.
  (`Lobby`서버가 죽으면 서비스 지속 불가)
- `Redis`를 사용하여 구현할 경우 `Redis`가 `단일고장점`이 될수 있으나, `Redis Clustering`을 통해서
  `고가용성`을 확보가능.
  (왠만하면 다운되는 경우가 없으므로 비용 고려하여 클러스터링 적용 여부 타진)
- `Lobby` 서버의 구조를 급진적으로 개선이 힘들다고 판단되면, 퇴역시켜서 구조를 유연하게 구성
- Broadcasting이 필요한 경우에는 `Redis` 및 `SQS`, `RabbitMQ` 같은 `MessageQueue` 도입검토.

- 참고로 기존 `Lobby` 서버는 다음의 기능을 담당했음.
  1. Matchmaking
  2. 구동중인 각 리얼타임 서버들의 목록 관리
  3. 타운 이동시 `Load balancing`
  4. 일부 이벤트 Broadcasting

#### 4. SP(Stored Procedure) 사용 줄이기 (개선사항)
- SP 및 호출 코드 모두를 살펴봐야 하는 이유로 인해서 수정이 용이하지 않음.
- 라이브 상황에서 DB 로직을 긴급히 적용하는게 유리하다고 판단되는 경우가 아니라면 사용을 자제
- MySQL 버그로 인해서 SP 사용시 메모리 사용량 증가 이슈도 우려됨.
- 간단하거나 라이브 긴급 패치 이슈가 없다면 `SQL RAW QUERY` 문으로 대체 검토.

#### 5. 서버 배포 과정 간소화 및 자동화 (개선사항)
- 라이브 서버 배포시 각종 파일 복사 및 서비스 시작 작업시에 과정이 다소간 있는 상태여서, 이를 줄여서 실수를 최대한 줄여나감.
- DB 스키마 패치시 도구를 이용해서 과정을 투명화함.
  (현재는 수작업에 의존하는 형태임)

#### 6. 서버 디버깅 환경 보강 (개선사항)
- 현재 로그외에는 디버깅 방법이 없는 상태이므로, 신속한 대응이 쉽지 않은 상황이므로,
  디버깅 도구등을 마련하여 신속한 대응을 할 수 있도록 기반 조성

#### 7. 서버 로그 정리 (개선사항)
- 과도하게 기록하고 있는 로그 정리 및 제거
- 로그 레벨을 정리해서 경고성인지 오류인지 명확하게 구분

#### 8. 인벤토리등에서의 갯수 제한 (개선사항, 기획 검토)
- 현재 인벤토리에 아이템 추가시 제한이 없이 무한대로 넣을 수 있는 구조이기 때문에 궁극적으로 아이템 갯수가 많이지게 되면 병목이 발생할 수 있기에 이 부분에 대한 고려가 필요함.

#### 9. 리얼타임 서버에서 DB에 직접 접근 (개선사항)
- 현재 리얼타임 처리하는 곳에서 게임 서버에 직접 요청하는 경우가 많은데, 레이턴시등의 이유로 `Game(WAS)` 서버에 요청해서 처리하는게 유리하다고 판단됨.
- 점진적으로 작업해도 무방하나, 가급적 한번에 `Game(WAS)` 서버에 요청하는 형태로 옮겨주는게 바람직해보임.
- 상기 작업은 클라이언트/서버 모두 같이 작업해야함.
  (소스코드 정리 수준의 작업이므로 부담은 크지 않음.)

#### 10. 서버 이름 정리 (개선사항)
- 타운서버등의 이름이 겹치거나 모호한 부분이 있어서 정리가 필요해보임.


---

#### 버그 픽스 사항

1. 인게임 상점 재화부족시 에러코드 별도로 정의

2. 업적 추가 사항 처리

3. 상점 데이터 패치
   - 라이브 상점 테이블 패치

4. 로그 내용 보완
   - 트로피 보상 로그에 몇단계 보상인지 json data 값으로 넣어둘것.
   - 하루하루 트로피 레벨 유저 수 로그
   - 재활용 했을 때 얻은 포인트
   - NewDuid추가
   - 2월 1일 오다혜님 메일로 로그 요청 하신것 처리할것.

5. DB 처리 웹으로 이동
   - 좀비 바이러스 보상 웹으로 처리
   - 광보 보상 웹으로 처리

6. 로비 서버에서 받은 패킷 처리하는것 개선
   - 현재 싱글스레드로 돌고 있어서 처리가 밀릴수 있음.

7. 점검 킥 메시지 못받는 유저들 존재?
   - 모두 받을 수 있도록 수정해야함.

8. 서버 내렸을때 접속중이던 유저 레디스 정리 안되는것 처리.
   - 점검시마다 `Redis`를 `Flush`해주는 형태로 운용.

9. `Task.Run`으로 처리하는곳 `Guard`처리
   - Try~Catch로 묶어서 에러 전파를 지역화함.

10. 초당 10명 접속 처리 안되는것 확인
   - 스트레스 테스트로 해당 사항 확인.

11. 회원 탈퇴 유저 정리 SP 작성(DB 처리 미비)
   - 일부 기능이 덜 구현되어 있어서 마무리 작업 해야함.

12. 유저 접속 몰릴때 처리
   - 몰려서 처리될때 제대로 처리되는지 확인.

13. 분산처리 제대로 안된것 처리
   - 몰려서 처리될때 제대로 처리되는지 확인.
   - 태스크가 효율적으로 관리되고 있는지 여부 확인.

14. 죽은 서버 체크 제대로 안된것
   - `Health` 체크가 어떤 이유로든 제대로 안되는 문제가 있는것 같음.

15. 배틀서버 업데이트 개선
   - 방마다 `Update Task` 루프가 있음. 최적화 이슈
   - 성능상 문제가 없다면 놔둬도 됨.
   - 단, 현재 20% 점유를 꾸준히 하고 있는 상태이므로 확인이 필요해보이긴 함.
   - 활성화 유저가 있는지 여부와 상관 없이 항상 20% 내외의 부하가 걸림

16. 젠킨스 데이터 리플레시 추가
   - 리플레시 대상이 되는 테이블을 선택해서 처리할 수 있도록 수단 제공
   - 개발 과정 효율 향상 이슈
   - 전체 테이블을 리플레시 하면 오래 걸리므로 관심 테이블만 리플레시 할 수 있도록 수단 제공
