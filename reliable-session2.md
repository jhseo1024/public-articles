# Reliable Session

모바일 네트워트처럼 연결 끊김이 빈번한 환경에서 안정적인 게임 서비스를 제공하려면 충분한 준비가 필요합니다.

끊어진 TCP 연결을 다시 맺는 것은 어렵지 않지만 재연결 처리 중 유실된 메시지를 구분하거나, 유실 여부를 판단하기는 매우 어렵기 때문입니다. 만약, 이 메시지들을 직접 구분하려면 클라이언트와 서버 코드 모두 복잡해질 것입니다.

유실된 메시지를 복원하지 못하면 게임을 진행하는데 필요한 정보 전체 또는 일부가 사라지므로 게임을 진행할 수 없거나 예상하지 못한 문제가 발생할 가능성이 매우 높습니다. 그래서 사용자 연결을 강제로 끊거나, 게임을 재시작 해야합니다. 네트워크 환경이 불안정한 곳에서 게임을 플레이하는 사용자들은 매우 불편해할 것입니다.

자 그래서 연결 끊김이 빈번한 환경에서도 안정적으로 메시지를 처리하는 방법에 대해서 설명해 보도록 하겠습니다.

    셀룰러 <-> WIFI 핸드오버 문제점

네트워크 핸드오버가 일어날때 실제로 연결이 끊어지게 됩니다.
또한 IP가 변경 되기도 합니다.

더 애매한 문제는 신호가 약해져서 PC에서 랜선을 뽑은 상태와 비슷한 상황이 발생합니다.

새로 전환된 네트워크를 인식하는데 일정시간이 필요합니다.

연결을 복원하는 과정에서 다소간의 지연이 발생합니다.

```
    재연결

    재인증

    인증확인

    상대측에서 미수신한 메시지 재전송
```

```
    HandoverBegin
    HandoverEnd
    HandoverFailed
```

## 한계점

- WIFI 수신 감도가 낮아졌을 경우 아직 끊기지는 않았지만 정상적이지는 않음.
- 서버가 LB(Load Balancer) 뒤에 위치한 경우 이전에 접속했던 서버로 접속한다는 보장이 없음.


보낸 메시지 마다 번호를 붙여주어서 해당 메시지가 수신되었는지 여부를 확인할 수 있어야함.

전송 보장이 필요없는 메시지들에 대해서는 이러한 처리를 하지 않는다.
이를테면, 핑 메시지 같은것들은 유실되어도 무방하기 때문이다.

## ACK 전송주기

메시지를 수신할때마다 `ACK`를 보내주면 그리 효율적이지 못할것입니다. 그리고 실제로 매번 보내줄 필요도 없습니다. 일정한 간격마다 보내주어도 문제가 발생하지는 않습니다.
다만, 메시지를 보내는 쪽에서 일정 수의 메시지를 보전해주어야하는 부담이 발생할 뿐입니다.

## LB(Load Balancer) 뒤에 서버가 위치한 경우

LB뒤에 서버가 위치한 경우에는 클라이언트가 다시 접속할때 이전에 접속했던 서버에 접속하지 못할수도 있습니다. 세션의 상태가 이전 서버의 메모리에 있기 때문에 이전 서버로 접속해야하는데, LB를 거치게 되면 다른 서버로 접속할수도 있기 때문입니다. 물론, 세션의 상태를 게임 서버가 아닌 `REDIS`등에 위치시킨다면 상관없이 없겠지만, 그렇지 않은 경우에는 게임서버의 주소가 고정이 되어 있어야할것입니다.

| 상태 | 설명 |
|:--|:--|
|None|초기화에 사용되는 상태입니다.|
|Connecting|TCP 연결중인 상태입니다.|
|Handshaking|암호화 통신을 위한 암호화 키를 주고 받는 과정입니다.|
|Connected|연결된 상태입니다.|
|Restore|상대방의 `ACK` 수신을 기다리는 중입니다.|
|Standby|전송 가능한 상태입니다.|
|Established|세션 ID가 설정된 상태입니다.|

## 세션 객체 유지 시간

연결이 끊긴 상태에서 무한정 세션 객체를 서버 메모리에 남겨둘수는 없을것입니다. 이런식으로 계속해서 남겨두게 되면 언젠가는 서버 메모리는 모두 고갈될것입니다. 일정 시간내에 재접속이 이루어지지 않는다면 해당 세션 객체를 메모리 상에서 내려주는 과정이 필요할것입니다. 30초내에 재접속이 이루어지지 않는다면 메모리에서 내려준다 정도의 처리가 있으면 될것입니다.

## 메시지 재전송 시 고려사항

재접속시 암호화 키를 새로 교환하게 되므로, 이전에 전송했던 메시지를 그대로 보내게 되면 상대측에서 메시지를 제대로 디코딩할 수 없을것입니다. 재접속 이후 다시 보내는 메시지일 경우에는 새로 교환한 암호화 키로 인코딩해서 보내주어야 할것입니다.

## 명시적 끊음

`Disconnect()` 함수를 직접 호출해서 끊었을 경우에는 재연결 처리를 수행하면 안될것입니다. 원치 않게 끊겼을때와 임의로 끊었을때를 구분지어서 처리해주면 됩니다.

