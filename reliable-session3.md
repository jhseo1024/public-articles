# Reliable Session

모바일 네트워크 처럼 연결 끊김이 빈번한 환경에서는 안정적인 게임 서비스를 제공하려면, 추가적인 고려사항이 있습니다.

크게 두가지가 있습니다.

- 배터리 소모
- 불안정한 네트워크

네트워킹시에 예상 보다는 다소 상회하는 배터리 소모가 발생합니다. 최대한 적은 데이터를 주고 받으면 완화시킬수는 있겠지만, 완벽하게 대응할 수는 없습니다. 최대한 전송되는 데이터를 줄이고 횟수를 줄이는 노력하는 방법 외에는 없습니다.

다음으로 모바일 네트워킹 환경은 `PC 네트워킹` 환경과는 다르게 매우 불안정합니다. `PC`에서도 무선 공유기등을 사용하기는 하지만, `PC`는 고정된 환경에서 사용하고 모바일은 이동중에 사용하기 때문에 많이 좋아졌다고는 하나 물리적인 특성으로 인해서 불안정한 환경에 자주 노출되곤 합니다. 이 글에서는 이 불안정한 네트워크 환경을 극복(완화)하는 방법에 대해서 알아보고자 합니다.

모바일에서는 TCP 연결이 자주 끊기곤합니다.

끊어진 TCP 연결을 다시 맺는것은 어려운 일이 아니지만, 재 연결중 유실된 메시지를 복원하는것은 쉬운 과정이 아닐 수 있습니다. 더욱이 이러한 처리를 응용레벨에서 처리하는것은 프로그램을 지나치게 복잡하게 만들수 있습니다. 또한 응용레벨의 작업자들은 네트워크 숙련자들이 아닐수 있으므로 그 부담을 지게 하는것은 바람직하지 않을것입니다.

재접속 과정에서 유실된 메시지를 복원하지 못하고 그대로 내버려둘 경우에는 게임의 상태가 정상적이지 않을 수 있으므로, 재연결 후에 게임을 이어서 할 수 없을수 있습니다. 보통 이러한 경우에 가장 손쉬운 방법은 접속이 끊기면 강제로 `홈`으로 보내버리고 재접속을 강제할 수도 있습니다. 하지만, 플레이어는 이러한 과정을 불편하게 생각할것이고 게임의 흐름을 이어갈 수 없는 상황이 될것입니다.

더욱이 모바일 환경에서는 이러한 순간적인 끊김이 빈번하게 발생한다는 것입니다. 수초 이내의 짧은 연결 끊김으로 인해서 매번 홈 화면으로 보내버리면, 플레이어는 안정적인 게임서비스를 받고 있다는 생각을 하지 못할것입니다. 플레이어의 네트워크 환경이 열악하다는 생각은 하지 못한채로 불만만 쌓여 갈것입니다.

이 글에서는 이러한 상황을 개선하기 위한 방법에 대해서 설명하고자 합니다.

## 연결이 끊기는 이유

우선 자세한 설명에 앞서 모바일 네트워크 환경의 특성에 대해서 알아 보겠습니다. 모바일은 `PC` 네트워크 환경과 달리 전적으로 무선 환경입니다. 무선 환경은 유선에 비해 상대적으로 매우 불안정한 채널이며 언제든 연결이 끊길 수 있습니다. 특히 이동중에는 `WiFi` <-> `LTE` 로의 전환이 빈번하게 발생할수도 있습니다. 전환이 일어나게 되면 한동안은 통신이 이루어지 않으며, 절체 후에는 네트워크 접손이 끊김은 물론이고, 기기의 `IP` 주소가 변경되는 등의 변화가 있을 수 있습니다.

바로 이러한 부분에 대한 대비를 해두어야만 원활한 모바일 네트워크 서비스를 할 수 있을것입니다.

## 극복이 어려운 점

하지만, 이러한 처리가 모든 상황을 극복하지는 못합니다. 다음의 상황에서는 유저를 `홈` 화면으로 보내야할지도 모릅니다. 다만, 이러한 처리를 함으로써 서비스의 질을 조금더 향상시킬 수 있을겁니다.

- `WiFi` 수신 감도가 낮아졌을 경우, 커넥션이 끊김을 감지할때까지 상당시간 소요됨.
- `LB(Load Balancer)` 뒤에 서버가 위치해 있을 경우.

위 문제들에 대해서는 아래에서 좀더 자세하게 다루겠습니다.

### WiFi 수신 감도가 낮아졌을 경우

`WiFi` 수신 감도가 낮아진 경우에는 이게 실제로 끊기기까지 시간이 필요하다는게 문제입니다. 실제로 끊긴건지 일시적으로 낮아졌다가 다시 원래대로 돌아오는것인지 인식하는데 다소의 시간이 걸리기 때문에 다소간의 지연은 불가피하게 됩니다. 바로 연결이 끊어지고 재빠르게 다시 접속하는게 유리하다고 판단할수도 있겠지만, 연결 과정은 다소 복잡한 과정을 거치기 때문에 잦은 재접속이 꼭 유리한것만은 아닐것입니다. 대개의 경우 실제 연결이 끊겼는지 여부를 판단하는 임계치(timeout)이 있기 마련인데 이 값이 민감하게 반응하는것을 피하기 위해서 큰 값으로 설정되어 있곤합니다. 이러한 이유로 어느정도 시간이 흐른 뒤에서 실제 접속이 끊겼음을 감지하게 됩니다. 사용자는 이 시간동안 멍하게 있을수 밖에 없을것입니다.

### `LB(Load Balancer)` 뒤에 서버가 위치해 있을 경우

부하 분산을 위해서 보통 서버들을 `LB` 뒤에 위치시킵니다. 보통의 웹서버 경우에는 문제가 없지만, 상태를 가지고 있는 서버의 경우에는 재접속시에 문제가 발생합니다. 접속이 끊기기 전의 서버에 상태가 있었을테고, 상태를 이어가기 위해서는 이전 서버로 접속을 해야할것입니다. 세션 혹은 게임의 상태가 이전 서버의 메모리등에 있을테니, 반듯이 이전 서버로 접속을 해야하는데 `L4` 뒤에 서버가 위치해 있기 때문에 다른 서버에 접속하게 되면, 재접속이 아닌 최초 접속으로 인식하게 될것이고, 상태를 이어갈 수 없을 것입니다. 이를 해결하는 가장 간단한 방법은 각 서버에 `Public IP`를 부여하고 최초 접속시에는 `L4`를 통해서 접속하고 재접속시에는 이번에 접속했던 서버의 `Public IP`로 접속을 하도록 하면 해결할 수 있습니다. 각 서버들마다 `Public IP`를 부여해야하는 부담은 발생하지만 실제로 `Public IP` 대여 비용은 크지 않은 편이니 크게 문제가 될 부분은 아니라고 생각됩니다.

## 네트워크 단절시 발생하는 상황

